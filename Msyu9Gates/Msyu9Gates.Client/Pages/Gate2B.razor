@page "/Z2F0ZTJi" // This is the route for Gate2B
@rendermode InteractiveAuto
@inject NavigationManager nav
@inject IJSRuntime js

<PageTitle>Ynnejynnej</PageTitle>

<h3>Gate - 2B</h3>
<div class="keypad-container">
    <input type="text" readonly class="keypad-display" value="@Key" />
    <div class="keypad-grid">
        @for (int i = 1; i <= 9; i++)
        {
            int value = i;
            <button class="keypad-btn" @onclick="() => AddDigit(value)">@value</button>
        }
        <button class="keypad-btn zero" @onclick="() => AddDigit(0)">0</button>
    </div>
    <button class="keypad-btn submit" @onclick="Submit">Submit</button>
    <button class="keypad-btn clear" @onclick="ClearInput">Clear</button>
</div>

@{
    if (isClueFor2CEnabled)
    {
        <br />
        <a href="@GetHintURL()" class="btn btn-link">Clue earned from completing 2C</a>
        <br />
    }
}

<br />
<h4>Recent Attempts</h4>
<ul>
    @foreach (var attempt in _attempts)
    {
        <li>@attempt</li>
    }
</ul>

@code {
    private string Key { get; set; } = "";
    private List<string> _attempts = new List<string>();
    private bool isClueFor2CEnabled = false;
    private HttpClient http = new HttpClient();

    protected override async void OnInitialized()
    {  
        Uri uri = new Uri(nav.BaseUri + "api/Is2CClueEnabled");
        var response = await http.GetAsync(uri);
        isClueFor2CEnabled = await response.Content.ReadFromJsonAsync<bool>();
        await GetRecentAttempts();
    }    

    private async void Submit()
    {
        // Clue for 2B
        string? responseMessage = await CheckKey("0003");
        if (responseMessage!.Equals("Success"))
        {
            await js.InvokeVoidAsync("alert", $"Key Obtained:  0003_{Key}.\nBack to the root we go!");
            nav.NavigateTo("/", forceLoad: false);
        }

        responseMessage = await CheckKey("0004");
        if (responseMessage!.Equals("Success"))
        {
            // Move to 2C - Final Step for Gate 2
            await js.InvokeVoidAsync("alert", $"Key Obtained:  0004_{Key}");
            nav.NavigateTo("/gate2c-75260986245481", forceLoad: false);
        }

        responseMessage = await CheckKey("0006");        
        if (responseMessage!.Equals("Success")) // Final Code for Gate 2
        {
            await js.InvokeVoidAsync("alert", $"Key Obtained:  0006_{Key}. Gate 2 Complete. Gate 3 will be available soon.");
            nav.NavigateTo("/", forceLoad: false);
        }


        ClearInput();
        await GetRecentAttempts();
    }

    private void AddDigit(int digit) => Key += digit.ToString();
    private void ClearInput() => Key = "";

    private async Task GetRecentAttempts()
    {
        Uri uri = new Uri(nav.BaseUri + "api/Gate2B_Attempts");
        var response = await http.GetAsync(uri);
        _attempts = await response.Content.ReadFromJsonAsync<List<string>>() ?? new List<string>();
    }

    private async Task<string> CheckKey(string key_number)
    {
        Uri uri = new Uri(nav.BaseUri + "api/" + key_number);
        var response = await http.PostAsJsonAsync(uri, Key);
        return await response.Content.ReadFromJsonAsync<string>() ?? "Failure";        
    }

    private string GetHintURL()
    {
        return "https://www.barnesandnoble.com/w/moby-dick-herman-melville/1116610565";
    }
}
