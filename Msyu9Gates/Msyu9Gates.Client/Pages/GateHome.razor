@page "/gate/{gateNumber:int}"
@rendermode InteractiveAuto
@attribute [Authorize]

@inject NavigationManager nav
@inject IJSRuntime js
@inject IConfiguration config

@using System.Configuration 

<PageTitle>@title</PageTitle>

@if(gate is null)
{
    <p><em>Loading gate information...</em></p>
}
else
{

    @if(gate!.IsCompleted) // change these to gate statuses later.
    {
        <img src="/Images/[AIGen] GateComplete.png" alt="Gate Complete" class="page-sign" />
    }
    else if(gate!.IsLocked)
    {
        <img src="/Images/[AIGen] GateLocked.png" alt="Gate Locked" class="page-sign" />
    }
    else
    {
        <div class="container">
            <article>
                <h3 style="color: red"> @title Chapter Select</h3>
                        
                @for(int i = 1; i <= chapters.Count; i++)
                {
                    int ch = i;
                    <button class="btn btn-primary" @onclick=@(() => nav.NavigateTo($@"/gate/{gateNumber}/chapter/{ch}/narrative"))>Chapter @Utils.ToRoman(ch)</button>
                    if(i < chapters.Count) { <span> | </span> }
            
                    @*Example Disabled for use later when disabled logic is re-added*@
                    @* <button class="btn btn-primary" @onclick=@GoToChapterThree>Chapter III</button> *@
                }
                <br />
                <br />
            </article>
        </div>
        <br />
        <p>Gate Difficulty: @(GetGateDifficulty(gate?.GateOverallDifficultyLevel ?? 0) ?? "TBD")</p>

        @foreach (var (line, idx) in articleBody.Split('\n').Select((l, i) => (l, i)))
        {
            <div class="narrative-line" style="animation-delay:@($"{idx * 1.5:F1}s")">
                @line
            </div>
            <br />
        }
    }
}
@code {
    string articleBody = string.Empty;
    string? title;

    [Parameter] public int gateNumber { get; set; }

    GateDto? gate;
    List<ChapterDto> chapters = new List<ChapterDto>();

    HttpClient http = new HttpClient();

    private int _lastLoadedGate = 0;

    protected override async Task OnParametersSetAsync()
    {
        title = $"Gate {Utils.ToRoman(gateNumber)}";

        if (_lastLoadedGate == gateNumber) return;

        // Clear previous data
        articleBody = string.Empty;
        gate = null;
        chapters = new List<ChapterDto>();

        await GetGateInfoAsync();
        await GetChaptersAsync();

        _lastLoadedGate = gateNumber;
        articleBody = await Common.GetNarrative(nav, http, gateNumber);
    }

    private string GetGateDifficulty(int gateNumber) => Enum.GetName(typeof(Utils.Difficulty), gateNumber) ?? "Unknown";

    private async Task GetGateInfoAsync()
    {
        Uri uri = new Uri(nav.BaseUri + $"api/gates/{gateNumber}");
        var response = await http.GetAsync(uri);
        if (response.IsSuccessStatusCode)
        {
            gate = await response.Content.ReadFromJsonAsync<GateDto>();
        }
        StateHasChanged();
    }

    private async Task GetChaptersAsync()
    {
        Uri uri = new Uri(nav.BaseUri + $"api/chapters/{gateNumber}");
        var response = await http.GetAsync(uri);
        if (response.IsSuccessStatusCode)
        {
            chapters = await response.Content.ReadFromJsonAsync<List<ChapterDto>>() ?? new List<ChapterDto>() { };
        }
        StateHasChanged();
    }
}
